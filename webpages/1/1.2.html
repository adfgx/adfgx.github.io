<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autodesk Forge Viewer - Selective Loading</title>
    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" type="text/css">
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
    <style>
        body, html { margin: 0; height: 100%; overflow: hidden; }
        #forgeViewer { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="forgeViewer"></div>
    <script>
        const CLIENT_ID = 'XtVAoS3rpmt1k8Ax7Bj7bcZIYVWtGL16AivFXLipu1bGzTyv'; // Replace with your APS client ID
        const CLIENT_SECRET = 'Dgi6V62fKcKg2AfHrFdEnRStdWuBlLl3f63STSZhek7ZN8ys9s2vm9iU8SS14Vbk'; // Replace with your APS client secret
        const MODEL_URN = 'dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6M2RfYWRfYXBpX3Zfci9KNzJRK01SNSwlMjBTaGF3aW5pZ2FuLCUyMFFDX2FycS1hLnJ2dA'; // Replace with your model's URN (Base64 encoded)

        let viewer;
    
        async function getAccessToken() {
            const response = await fetch('https://developer.api.autodesk.com/authentication/v2/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    client_id: CLIENT_ID,
                    client_secret: CLIENT_SECRET,
                    grant_type: 'client_credentials',
                    scope: 'viewables:read'
                })
            });
            const data = await response.json();
            return data.access_token;
        }
    
        async function initializeViewer() {
            const accessToken = await getAccessToken();
            const options = {
                env: 'AutodeskProduction2',
                api: 'streamingV2',
                getAccessToken: (onTokenReady) => onTokenReady(accessToken, 3600)
            };
    
            Autodesk.Viewing.Initializer(options, () => {
                const viewerDiv = document.getElementById('forgeViewer');
                viewer = new Autodesk.Viewing.GuiViewer3D(viewerDiv);
                viewer.start();
    
                const documentId = 'urn:' + MODEL_URN;
                Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
            });
        }
    
        function onDocumentLoadSuccess(doc) {
            const viewables = doc.getRoot().search({ type: 'geometry' });
            if (viewables.length === 0) {
                console.error('No viewables found.');
                return;
            }
    
            // Define metadata filters to exclude specific categories
            const metadataFilters = {
                objectid: {
                    $nin: [182, 203, 204]  // Exclude Generic Models, Site, and Planting
                }
            };
    
            // Load the model with the defined filters
            viewer.loadDocumentNode(doc, viewables[0], { filter: metadataFilters });
        }
    
        function onDocumentLoadFailure(error) {
            console.error('Failed to load document:', error);
        }
    
        document.addEventListener('DOMContentLoaded', initializeViewer);
    </script>
    
</body>
</html>
