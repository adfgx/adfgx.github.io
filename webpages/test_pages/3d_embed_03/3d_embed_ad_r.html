<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=no" />
    <meta charset="utf-8">

    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" type="text/css">
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>

    <style>
        body {
            margin: 0;
        }
        #forgeViewer {
            width: 100%;
            height: 100vh; /* Full viewport height */
            margin: 0;
            background-color: #F0F8FF;
        }
    </style>
</head>
<body>
    <div id="forgeViewer"></div>

    <script>
        // Replace these variables with your actual values
        const CLIENT_ID = 'XtVAoS3rpmt1k8Ax7Bj7bcZIYVWtGL16AivFXLipu1bGzTyv'; // Replace with your APS client ID
        const CLIENT_SECRET = 'Dgi6V62fKcKg2AfHrFdEnRStdWuBlLl3f63STSZhek7ZN8ys9s2vm9iU8SS14Vbk'; // Replace with your APS client secret
        const MODEL_URN = 'dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6M2RfYWRfYXBpX3Zfci80NDdfQmx2ZC5TYW1zb25fTGF2YWxfUUNfSDdYXzFKNS5ydnQ'; // Replace with your model's URN (Base64 encoded)

        let viewer;
        let tokenRefreshInterval;

        // Function to fetch a new access token
        async function getAccessToken() {
            const response = await fetch('https://developer.api.autodesk.com/authentication/v2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    client_id: CLIENT_ID,
                    client_secret: CLIENT_SECRET,
                    grant_type: 'client_credentials',
                    scope: 'viewables:read',
                }),
            });
            const data = await response.json();
            return data.access_token;
        }

        // Initialize the Autodesk Viewer
        async function initializeViewer() {
            const ACCESS_TOKEN = await getAccessToken();
            const options = {
                env: 'AutodeskProduction',
                api: 'derivativeV2', // For SVF2 models
                accessToken: ACCESS_TOKEN,
            };

            // Create the viewer instance
            viewer = new Autodesk.Viewing.GuiViewer3D(document.getElementById('forgeViewer'), {});

            // Start the viewer
            Autodesk.Viewing.Initializer(options, () => {
                viewer.start();
                loadModel(viewer, MODEL_URN);
            });

            // Set up token refresh every 45 minutes (2700000 milliseconds)
            tokenRefreshInterval = setInterval(async () => {
                const newToken = await getAccessToken();
                viewer.setAccessToken(newToken);
                console.log('Token refreshed successfully.');
            }, 45 * 60 * 1000); // 45 minutes
        }

        // Load the model into the viewer
        function loadModel(viewer, urn) {
            Autodesk.Viewing.Document.load(
                `urn:${urn}`,
                (doc) => {
                    const viewables = doc.getRoot().getDefaultGeometry();
                    viewer.loadDocumentNode(doc, viewables);
                },
                (errorCode, errorMsg) => {
                    console.error('Error loading model:', errorMsg);
                }
            );
        }

        // Initialize the viewer when the page loads
        window.onload = initializeViewer;

        // Clear the interval when the page is unloaded
        window.onbeforeunload = () => {
            clearInterval(tokenRefreshInterval);
        };
    </script>
</body>
</html>