<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=no" />
    <meta charset="utf-8">

    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" type="text/css">
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #forgeViewer {
            width: 100%;
            height: 90vh; /* Full viewport height */
            margin: 0;
            background-color: #F0F8FF;
        }
        #controls {
            padding: 10px;
            background-color: #f8f8f8;
            text-align: center;
        }
        select, button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label for="viewableSelect">Choose a Viewable:</label>
        <select id="viewableSelect" onchange="loadSelectedViewable()">
            <option value="">-- Select a Viewable --</option>
        </select>
    </div>
    <div id="forgeViewer"></div>

    <script>
        // Replace these variables with your actual values
        const CLIENT_ID = 'XtVAoS3rpmt1k8Ax7Bj7bcZIYVWtGL16AivFXLipu1bGzTyv'; // Replace with your APS client ID
        const CLIENT_SECRET = 'Dgi6V62fKcKg2AfHrFdEnRStdWuBlLl3f63STSZhek7ZN8ys9s2vm9iU8SS14Vbk'; // Replace with your APS client secret
        const MODEL_URN = 'dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6M2RfYWRfYXBpX3Zfci80NDdfQmx2ZC5TYW1zb25fTGF2YWxfUUNfSDdYXzFKNS5ydnQ'; // Replace with your model's URN (Base64 encoded)

        let viewer;
        let tokenRefreshInterval;
        let viewableNodes = []; // Array to store viewable nodes (states)
        let currentDocument; // Store the loaded document

        // Function to fetch a new access token
        async function getAccessToken() {
            const response = await fetch('https://developer.api.autodesk.com/authentication/v2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    client_id: CLIENT_ID,
                    client_secret: CLIENT_SECRET,
                    grant_type: 'client_credentials',
                    scope: 'viewables:read',
                }),
            });
            const data = await response.json();
            return data.access_token;
        }

        // Initialize the Autodesk Viewer
        async function initializeViewer() {
            const ACCESS_TOKEN = await getAccessToken();
            const options = {
                env: 'AutodeskProduction',
                api: 'derivativeV2', // For SVF2 models
                accessToken: ACCESS_TOKEN,
            };

            // Create the viewer instance
            viewer = new Autodesk.Viewing.GuiViewer3D(document.getElementById('forgeViewer'), {});

            // Start the viewer
            Autodesk.Viewing.Initializer(options, () => {
                viewer.start();
                loadModel(viewer, MODEL_URN);
            });

            // Set up token refresh every 45 minutes (2700000 milliseconds)
            tokenRefreshInterval = setInterval(async () => {
                const newToken = await getAccessToken();
                viewer.setAccessToken(newToken);
                console.log('Token refreshed successfully.');
            }, 45 * 60 * 1000); // 45 minutes
        }

        // Load the model into the viewer
        function loadModel(viewer, urn) {
            Autodesk.Viewing.Document.load(
                `urn:${urn}`,
                (doc) => {
                    currentDocument = doc; // Store the document for later use

                    // Get all viewable nodes (states) from the document
                    viewableNodes = doc.getRoot().search({ type: 'geometry', role: '3d' });

                    // Populate the dropdown with viewable options
                    const viewableSelect = document.getElementById('viewableSelect');
                    viewableNodes.forEach((node, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `Viewable ${index + 1}`; // Customize this text if needed
                        viewableSelect.appendChild(option);
                    });

                    // Load the default viewable (first state)
                    if (viewableNodes.length > 0) {
                        viewer.loadDocumentNode(doc, viewableNodes[0]);
                    } else {
                        console.error('No viewable nodes found.');
                    }
                },
                (errorCode, errorMsg) => {
                    console.error('Error loading model:', errorMsg);
                }
            );
        }

        // Load the selected viewable
        function loadSelectedViewable() {
            const viewableSelect = document.getElementById('viewableSelect');
            const selectedIndex = viewableSelect.value;

            if (selectedIndex !== '' && viewableNodes[selectedIndex]) {
                viewer.loadDocumentNode(currentDocument, viewableNodes[selectedIndex]);
            }
        }

        // Initialize the viewer when the page loads
        window.onload = initializeViewer;

        // Clear the interval when the page is unloaded
        window.onbeforeunload = () => {
            clearInterval(tokenRefreshInterval);
        };
    </script>
</body>
</html>